# 文件格式模糊测试

* 文件格式模糊测试是一种针对特别定义的目标应用的特殊的模糊测试方法，这些目标应用通常是客户端应用。其中的例子包括媒体播放器、Web浏览器以及office办公套件。然而，目标应用也可以是服务器程序，如防病毒网关扫描器、垃圾邮件过滤器以及常用的邮件服务程序。文件模糊测试的最终目标是发现应用程序解析特定类型文件的缺陷。

* 大量的客户端文件格式解析漏洞在2005年和2006年被发现，其中许多是被进行恶意攻击的团体所发现的，因为在典型的漏洞发掘过程之前，发现了许多在安全补丁发布前而被了解和利用的漏洞信息。eEye安全研究组开展了很好的工作以将这些披露的漏洞详细的描述在他们的Zero-Day跟踪器中 。这里有大量的事实表明这些漏洞中的绝大部分是通过文件格式模糊测试而发现的。这种类型的错误远没有灭绝的迹象，这使得文件格式模糊测试成为一个非常有趣并且热门的研究课题。

* 这里提出了实现文件模糊测试的不同方法，同时也讨论了特定目标应用接收输入的不同方式。最后说明了文件模糊器将会遇到的普遍的漏洞，并且给出了在实际中检测这些漏洞的建议。当然，所要做的第一项工作就是选择一个合适的目标应用。

## 1 目标应用

* 就像传统类型的模糊测试一样，使用文件格式模糊测试可以发现许多不同类型的漏洞。同样，这里也有许多不同类型的发掘场景。例如，有些情形要求一个攻击者向用户发送一个恶意文件，并且让他或她手工的将文件打开。而其它的情形可能只要求一个用户浏览被攻击者控制的Web页。最后，有些场景能够通过简单的经由邮件服务器或防病毒网关发送一个恶意的邮件而触发。最后一个场景就是表1提到的微软的Exchange TNEF漏洞，同时该表也列出了其它文件格式漏洞的例子。

    | 应用分类 | 漏洞名 | 查询网站 | 
    | - | :-: | -: | 
    | Office办公 | 微软HLINK.DLL超链接对象库缓冲区溢出漏洞 | [链接地址](http://www.tippingpoint.com/security/advisories/TSRT-06-10.html) | 
    | 防病毒扫描 | 卡巴斯基防病毒引擎CHM文件解析器缓冲区溢出漏洞 | [链接地址](http://www.idefense.com/intelligence/vulnerabilities/display.php?id=318)| 
    | 媒体播放器 | Winamp m3u解析栈溢出漏洞 | [链接地址](http://www.idefense.com/intelligence/vulnerabilities/display.php?id=377)| 
    | Web浏览器 | 向量标记语言中的漏洞，可允许远程代码执行 | [链接地址](http://www.microsoft.com/technet/security/Bulletin/MS06-055.mspx) | 
    | 存档工具 | WinZip MIME解析器缓冲区溢出漏洞 | [链接地址](http://www.idefense.com/intelligence/vulnerabilities/display.php?id=76)|
    | 邮件服务器 | 微软Exchange TNEF解码器漏洞 | [链接地址](http://www.microsoft.com/technet/security/Bulletin/MS06-003.mspx)| 

* 大多数的目标应用都属于这些分类中的某一个类别。某些应用则由于它们的次要功能而同时属于多个分类。例如，许多防病毒扫描器也包括解压缩文件的库，以允许它们作为存档工具。还有一些内容扫描器声称可以为情色内容分析图像文件。这些程序也可以被认为是图像查看器 。应用程序共享公共库是很普遍的，在这种情况下一个单独的漏洞可以影响多个应用。例如，考虑一下在微软的安全公告MS06－055中详细描述的漏洞，它既可以影响Internet Explorer也可以影响Outlook。

## 2 方法
* 文件格式模糊测试与其它类型的模糊测试是不同的，因为它通常是在一个主机上完整的执行。当执行Web应用或网络协议模糊测试时，你很可能至少会使用两个系统，即一个目标系统和一个模糊器所运行的系统。通过能够在一个单独的机器上进行模糊测试而使性能得到了提高，这使得文件格式模糊测试成为一种很有吸引力的漏洞发现方法。

* 对于基于网络的模糊测试而言，在目标应用中何时发生一个有趣的条件通常是很明显的。在许多情况下，服务器将关闭或者立即崩溃，并且将不能够再连接。而对于文件模糊测试而言，主要是在对客户端应用进行模糊测试时，模糊器将会继续重新开始运行并且销毁目标应用，因此如果不使用适当的监视机制，那么模糊器将可能不会识别出一个崩溃情形。这是文件格式模糊测试比网络模糊测试更加复杂的一个应用领域。对于文件格式模糊测试而言，模糊器通常必须要监视目标应用的每次执行以发现异常。这通常可以通过使用一个调试库来动态的监视目标应用中已处理和未处理的异常来实现，同时要将结果记为日志以便于以后的评审。从较高的层次上看，一个典型的文件模糊器的工作过程如下：

    1. 通过变异或者生成来准备一个测试用例（后者使用的更多）。

    2. 部署目标应用并指示其加载测试用例。

    3. 监视目标应用以发现错误，通常是使用一个调试器。
    
    4. 当发现一个错误时，记录日志。同样，如果经过一段时间后没有错误被发现，手工销毁目标应用。

    5. 重复上述过程。

* 文件格式模糊测试可以通过生成和变异两种方法来实现。尽管这两种方法在实践应用中都很有效，但显然变异或"强有力"的方法更加易于实现。尽管生成方法或"智能强有力"模糊测试的实现要花费更多的时间，但它们可能将发现用其它的更原始的强有力方法所不能发现的一些漏洞。

### 2.1 强制性或基于变异的模糊测试

* 使用强制性模糊测试方法，你需要首先收集目标文件类型的一些不同的例子。你所能找到的不同文件越多，那么你的测试将越彻底。然后模糊器将作用在这些文件上，创建它们的变异文件，并通过目标应用解析器将它们进行发送。这些变异文件可以具有任意形式，这取决于在模糊器中所选择的方法。你可以使用的一个方法是用数据字节来替换字节。例如，遍历文件并用0xff替换每个字节。你也可以为多个字节执行此操作，例如两字节或四字节。你同样可以向文件中插入数据，而不只是覆盖字节。在测试字符串值时，这是一种非常有用的方法。然而，当向文件中插入数据时，需要注意可能会扰乱文件中的偏移量。这将会严重的破坏对代码的覆盖，因为某些解析器将会快速的检测一个无效文件并且退出。

* 校验和也可以破坏强制性解析器。由于任何的字节改变都将使校验和变为无效，因此解析应用程序很可能将退出，并且在一个潜在的漏洞代码片段能够被到达之前提供一个错误消息。该问题的解决方法，一是转换到智能模糊测试，这将在下一节中进行讨论。或者是停止在目标软件中的校验。停止软件的校验并不是一项简单的工作，通常需要进行逆向工程的大量工作。

* 一旦该方法被实现之后，为什么非常便于使用呢？答案很简单。因为终端用户不需要具备文件格式的任何知识，并且也不需要了解其工作机理。如果他们可以使用常用的搜索引擎或者通过搜索他们的本地系统来找到一些示例文件的话，他们就可以通过自己的研究来进行操作，直到模糊器发现某些感兴趣的内容。

* 这种模糊测试方法也具有一些缺点。首先，它是一种效率不高的方法，因此需要花费较多的时间来完成对一个单一文件的模糊测试。例如，对于一个基本的word文档的测试。即使是一个空文档，其大小也大约有20KB。每次对一个字节进行模糊化，那么将需要创建并部署20480个独立的文件。假定每个文件的处理需要2秒钟，那么总共将要花费11个小时，而这只是对一个单一字节值的处理。那么处理其它254个字节将会怎样呢？可以通过使用多线程模糊器在某种程度上回避这个问题，但它却说明了单纯的变异模糊测试具有不高的效率。简化这种模糊测试的另外一种方法是只关注文件中最有可能产生期望结果的那些部分，如文件头和字段头。

* 强有力模糊测试的主要缺点是几乎总是有许多的功能将会被遗漏掉，除非你以某种方式收集到包含每个和所有可能特性的一个示例文件集。大多数的文件格式都是很复杂的，并且包含大量的变换。当度量代码覆盖率时，你将会发现将一些示例文件使用于一个应用中并不像另外一种情形那样彻底的执行应用，这另外的情形就是用户真正的理解了文件格式，并且手工准备了一些针对文件类型的信息。这个问题可以使用文件模糊测试中的生成方法来解决，也即我们所说的智能强有力模糊测试。

### 2.2 智能强制性或基于生成的模糊测试

* 使用智能强制性模糊测试，你必须要首先花费一些精力来实际的研究文件规范。一个智能模糊器仍然是一个模糊测试引擎，因此仍然执行一个强制性攻击。然而，它依赖来自于用户的配置文件，以使测试过程更加智能。这些文件通常包含描述文件类型语言的元数据。可以将这些模板想象为数据结构的列表，它们的位置及其可能的取值都是相互关联的。在一个实现的层面上看，这些模板可以用许多不同的格式来表示。

* 如果一个没有任何公开文档的文件格式被选作用于测试，那么你作为一个研究者，则必须要在创建一个模板之前对格式化规范进行深入的研究。这可能需要逆向工程的知识，但首先要使用你的好朋友Google来查看一下是否已经有其他人为你做了这项工作。一些Web站点，如Wotsit的Format ，就提供了很好的官方和非官方的文件格式文档的服务。一个可选的作为补充的方法是比较文件类型的这些例子以发现一些模式，并且剖析一些被使用的数据类型。记住，一个智能模糊器的有效性直接相关于你对文件格式的理解以及采用一种通用方法将其描述给所使用的模糊器的能力。在第12章"文件格式模糊测试：UNIX平台上的自动化测试"中，当创建SPIKEfile时，我们将展示智能强有力模糊器的一个示例实现。

* 一旦一个目标应用和测试方法被确定，下一步就是针对所选定的目标应用，研究如何生成适当的输入向量。

## 3 输入

* 选择了一个目标应用之后，下一步就是枚举出该应用所支持的文件类型和不同向量的扩展以使这些文件被解析。可用的格式化规范也应当被收集并评审。即使在你只希望执行一个简单的强有力测试的情况下，具有相关的文件格式知识仍然是很有用的。关注于更加复杂的文件类型会更加有利，因为实现一个恰当的解析器将会是更加复杂的，因此发现一个漏洞的机会就会增加。

* 让我们通过一个例子来看一下如何收集输入。存档工具WinRAR 是一个免费使用的流行的存档工具。了解WinRAR将处理何种文件的一个简单方法是浏览WinRAR网站。在该网站的主页上，你将会看到它所支持的文件类型的一个列表。这些类型包括zip,rar,tar,gz,ace,uue以及其它的一些类型。

* 现在你已经知道了WinRAR所能处理的文件类型的列表，下一步就必须选择一个目标应用。有些时候，选择一个目标应用的最好方法就是寻找关于每个文件类型的信息，然后选择其中最复杂的一种类型。这里所假设的前提条件是复杂性通常会导致编码错误。例如，使用一些长标记值和用户提供的偏移量的文件类型可能会比基于静态偏移量和静态长度字段的简单文件类型更加具有吸引力。当然，一旦你掌握了模糊测试，你将会发现该规则也有许多例外的情况。在理想情况下，模糊器将最终面向所有可能的文件类型；第一个选择并不是十分重要，然而它总是有利于在针对特定应用的第一个模糊测试集中发现有趣的行为。

## 4 漏洞

* 当解析一个不规则文件时，一个编写的很差的应用程序易于受到不同类别漏洞的攻击。本节讨论其中的一些漏洞类别：
    * DoS（应用崩溃或挂起）
    * 整数处理问题
    * 简单的栈/堆溢出
    * 逻辑错误
    * 格式化字符串
    * 竞争条件

### 4.1 拒绝服务

* 尽管DoS问题在客户端应用中并不是十分有趣，但你需要记住我们也可以面向服务器应用，而该应用必须要保持对安全性和生产力的可用性。当然，这包括邮件服务器和内容过滤器。在实践应用中，导致文件解析代码中的DoS问题的一些常见原因包括越界读取、无限循环和空指针解除引用。

* 导致无限循环的一个通常错误是相信文件中制定其它块的位置的偏移量值。如果应用程序不能保证该偏移量使当前块向前移动，那么就会发生一个无限循环并导致应用程序无限制的重复处理同一个块或多个块。以前在ClamAV中已经有许多该类问题的实例。

### 4.2 整数处理问题

* 整数溢出和"有符号"问题在二进制文件解析中是非常普遍的。

* 这个例子说明了一个典型的导致内存破坏的整数溢出情况。如果文件为value值指定了最大的无符号32位整数（0xFFFFFFFF），于是第[2]行中的allocation_size变量由于一个整数溢出而被赋值为0。在第[3]行，该代码将导致用大小为0的值来调用内存分配函数。在这时，指针buffer将指向一个未分配的内存块。在第[4]行和第[5]行，应用程序执行循环并将个数等于size的初始值的大量数据复制到所分配的缓冲区中，从而导致一个内存破坏。

* 这种特殊情形并不总是能够被发现。它的可发现性取决于应用程序使用堆的方式。简单的覆盖内存中的堆通常不足以获得对应用程序的控制权。必须要采取一些操作使得被覆盖的堆数据能够被使用。在某些情况下，类似于此的整数溢出在堆内存被使用之前将导致一个非堆相关的崩溃的发生。

* 当然这只是一个例子，说明了在解析二进制数据时整数如何被不正确的使用。整数的错误使用还表现在其它的许多方面，包括经常提到的无符号整数比较错误。

* 如果size值是一个负数，那么该段代码将产生一个基于栈的溢出。这是因为在第[4]行的比较中，size（在第[1]行中定义）和MAX_ITEMS（在第[0]行定义）都被作为有符号数来处理，例如，－1小于512。在后面，当size在第[7]行的函数中被用做复制的边界变量时，它是被作为无符号数来处理的。例如，此时的值－1将被解释为42949672954294967295。当然，并不能保证可以发现这类情况，但在很大情况下依赖于readx_from_file函数的实现方式，可以通过监视变量以及将寄存器保存到栈的方法来发现此情况。

### 4.3 简单的栈和堆溢出

* 该问题已经被很好的理解，并且在以前已经出现过许多次了。一个典型的场景如下：一个固定大小的缓冲区被分配，无论它是位于栈中还是位于堆中。稍后，当从文件复制超过缓冲区大小的数据时，没有执行任何边界检查。在某些情况下，虽然会试图进行一些边界检查，但这些检查也是不正确的。当复制操作发生时，内存被破坏，通常还会导致任意代码执行。关于该类漏洞的更加详细的信息，请参阅"Shell编码手册：发掘并利用安全漏洞" 。

### 4.4 逻辑错误

* 依赖于文件格式的设计，可利用的逻辑错误可能会存在。尽管在对文件格式漏洞的研究过程中，我们没有亲自发现任何逻辑错误，但该类漏洞的一个极好的例子就是MS06-001所描述的微软的WMF漏洞 。该漏洞并不是源自于一个典型的溢出。实际上，它不要求任何类型的内存破坏，它允许一个攻击者直接执行用户提供的位置无关的代码。

### 4.5 格式化字符串

* 尽管大部分格式化字符串漏洞已经不存在了，特别是在开源软件中，但仍然有必要提及它们。当我们讲大部分不存在时，之所以这样说是因为并不是所有的程序员都能象US-CERT的程序员那样关注安全，US-CERT的程序员建议为了保证软件的安全性，不应当使用"％n"格式化字符串指定符 。

* 但情况更加严重，在我们亲自进行的实验中，当对文件进行模糊测试时确实发现了一些与格式化字符串相关的问题。其中的某些问题已经在Adobe 和RealNetworks 中发现。发现格式化字符串问题的许多乐趣来自于能够使用漏洞以泄露内存，从而帮助发现问题。不幸的是，由于使用非格式化文件的客户端攻击，你很少能够被提供这样的机会。

### 4.6 竞争条件

* 尽管人们通常不认为文件格式漏洞是由于竞争条件所引起的，但是有一些人是这样认为的，并且可能还会有更多的人这样认为。这种类型漏洞的主要目标应用是复杂的多线程应用。我们反对只面向一个特定的产品，但是微软的Internet Explorer是这里所想到的第一个应用程序。Internet Explorer使用非初始化内存以及其它线程正在使用的内存而导致的漏洞，将可能会被不断的发现。

## 5 漏洞检测

* 当对文件格式进行模糊测试时，通常要产生目标应用的许多实例。其中一些将会不确定的挂起并且必须要被销毁掉，一些将会发生执行崩溃，而另外一些将会主动的退出。所面对的挑战是需要确定一个已处理和未处理的异常何时发生，以及该异常何时被发现。一个模糊器可以利用一些源信息以发现一个进程的更多信息：

    * 事件日志。事件日志被微软的Windows操作系统所使用，它可以通过使用事件查看器应用程序来访问。事件日志对于我们来说并不是十分有用，因为当我们在模糊测试的过程中部署了成百上千个进程时，它很难将一个事件日志条目同一个特定的进程相关联。

    * 调试器。识别未处理和已处理异常的最好方法是在进行模糊测试之前将一个调试器关联到目标应用。错误处理将阻止由模糊测试而引起的许多错误的明显征兆的出现，但是这些错误通常可以使用调试器来发现。还有许多比使用调试器来进行错误检测更加先进的技术，其中的一些技术将在第24章"智能故障检测"中介绍。

    * 返回代码。捕获并测试应用程序的返回代码，虽然它不如使用调试器那样准确并提供详细的信息，但它是一种非常快速而有力的确定应用程序终止原因的方法。至少在UNIX平台上，它可以通过返回代码来确定是什么信号导致了应用程序终止。

    * 调试API。不使用第三方的调试器，而在模糊器中实现某些基本的调试功能通常是可行并且有效的。例如，对于一个进程而言我们所感兴趣的是它被终止的原因，当前的指令是什么，寄存器的状态以及栈指针或某些寄存器区域的内存值等。通常实现这些功能都很简单，并且在分析崩溃原因以查找漏洞的时间节省方面不具有应用价值。在下一章中，我们将研究该内容，并提出一个在微软Windows平台上的名为PyDbg的简单可复用的调试器创建框架，该框架是PaiMei 逆向工程架构的一部分。

* 一旦一个给定的测试用例被确定用来导致一个错误，则除了保存触发错误的实际文件之外，还必须要保存被你所选择的任何错误监视方法所收集的信息。同样，在你的记录中保存测试用例的元数据也是非常重要的。例如，如果模糊器使用第42个模糊值正在对文件中的第8个变量字段进行模糊测试，那么该文件就可以被命名为文件－8－42。在某些情况下，我们可能会释放一个内核文件并且也将其保存。如果一个模糊器使用调试API来捕获信号的话就可以实现这一点。

## 6 小结

* 尽管文件格式模糊测试是一种定义面较窄的方法，但是仍然有许多的目标应用和大量的攻击方法。这里不仅讨论了传统的客户端文件格式漏洞，而且涉及了一些远程服务的情形，如防病毒网关和邮件服务器。强调的重点放在了阻止和发现通过TCP/IP进行的基于网络的攻击，文件格式对于深入剖析内部网络段仍然是一种有价值的手段。



 

